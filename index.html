<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>Face Verification</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3390ec;
            --primary-light: #e9f3ff;
            --primary-dark: #2980b9;
            --success: #4CAF50;
            --success-light: #e8f5e9;
            --error: #f44336;
            --error-light: #ffebee;
            --warning: #ff9800;
            --warning-light: #fff3e0;
            --text-primary: #333333;
            --text-secondary: #757575;
            --border: #e0e0e0;
            --bg-light: #f8fafc;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            padding: 24px 16px;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .header p {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .privacy-notice {
            background-color: var(--primary-light);
            padding: 14px;
            border-radius: 12px;
            position: relative;
            border-left: 4px solid var(--primary);
            margin: 16px 0;
            display: flex;
            align-items: center;
        }
        
        .privacy-notice i {
            margin-right: 12px;
            color: var(--primary);
            font-size: 18px;
        }
        
        .privacy-notice p {
            margin: 0;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .privacy-notice p strong {
            font-weight: 600;
        }
        
        .camera-container {
            width: 100%;
            position: relative;
            margin: 20px 0;
            border-radius: 16px;
            overflow: hidden;
            aspect-ratio: 4/3;
            background-color: #000;
            box-shadow: var(--shadow);
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 16px;
            transform: scaleX(-1); /* Mirror the video */
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            color: white;
        }
        
        .face-outline {
            width: 200px;
            height: 200px;
            border: 3px dashed rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .face-outline::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
        }
        
        .camera-guide {
            margin-top: 16px;
            font-size: 14px;
            text-align: center;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
        }
        
        #canvas {
            display: none;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }
        
        .button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            padding: 16px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .button:hover {
            background-color: var(--primary-dark);
        }
        
        .button:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .button i {
            font-size: 18px;
        }
        
        .button-alt {
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .button-alt:hover {
            background-color: var(--primary-light);
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
            color: white;
            font-size: 16px;
            z-index: 100;
            backdrop-filter: blur(5px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .loading-overlay.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulsar {
            width: 16px;
            height: 16px;
            background-color: var(--primary);
            border-radius: 50%;
            position: absolute;
            top: 10px;
            right: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(51, 144, 236, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(51, 144, 236, 0); }
            100% { box-shadow: 0 0 0 0 rgba(51, 144, 236, 0); }
        }
        
        .status-message {
            margin: 16px 0;
            padding: 14px;
            border-radius: 12px;
            text-align: center;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            gap: 8px;
        }
        
        .status-message.error {
            background-color: var(--error-light);
            color: var(--error);
        }
        
        .status-message.success {
            background-color: var(--success-light);
            color: var(--success);
        }
        
        .status-message.warning {
            background-color: var(--warning-light);
            color: var(--warning);
        }
        
        .footer {
            margin-top: auto;
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
            padding: 16px 0;
        }
        
        /* Signature Canvas Styles */
        .signature-container {
            width: 100%;
            margin: 20px 0;
            display: none;
            flex-direction: column;
            align-items: center;
        }
        
        .signature-challenge {
            background-color: var(--primary-light);
            padding: 14px;
            border-radius: 12px;
            width: 100%;
            margin-bottom: 16px;
            font-weight: 500;
            text-align: center;
            color: var(--primary-dark);
        }
        
        #signatureCanvas {
            width: 100%;
            height: 200px;
            border: 2px dashed var(--border);
            border-radius: 12px;
            background-color: #fff;
            margin-bottom: 16px;
            touch-action: none;
        }
        
        .signature-controls {
            display: flex;
            width: 100%;
            justify-content: space-between;
            gap: 10px;
        }
        
        .signature-controls button {
            flex: 1;
        }
        
        #debug-console {
            width: 100%;
            height: 150px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #ddd;
            font-family: 'Courier New', monospace;
            padding: 10px;
            margin-top: 20px;
            border-radius: 12px;
            font-size: 12px;
            text-align: left;
            display: none;
        }
        
        .mode-switch {
            position: absolute;
            top: 12px;
            right: 12px;
            background-color: rgba(0, 0, 0, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .mode-switch:hover {
            background-color: rgba(0, 0, 0, 0.4);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease forwards;
        }
        
        .slide-up {
            animation: slideUp 0.5s ease forwards;
        }
        
        /* Media Queries */
        @media (max-width: 480px) {
            .app-container {
                padding: 16px 12px;
            }
            
            .card {
                padding: 16px;
                border-radius: 12px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .face-outline {
                width: 160px;
                height: 160px;
            }
            
            .face-outline::before {
                width: 140px;
                height: 140px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header slide-up">
            <h1>Verifikasi Wajah</h1>
            <p>Silakan tampilkan wajah Anda di depan kamera untuk verifikasi</p>
        </div>
        
        <div class="card fade-in">
            <div class="pulsar"></div>
            
            <div class="privacy-notice">
                <i class="fas fa-shield-alt"></i>
                <p><strong>Privasi Anda Penting:</strong> Gambar wajah Anda hanya digunakan untuk verifikasi saat ini dan <span style="text-decoration: underline;">tidak akan disimpan</span> setelah proses selesai.</p>
            </div>
            
            <div class="camera-container" id="cameraContainer">
                <video id="video" playsinline autoplay muted></video>
                <div class="camera-overlay">
                    <div class="face-outline"></div>
                    <p class="camera-guide">Posisikan wajah Anda di dalam lingkaran</p>
                </div>
                <canvas id="canvas"></canvas>
                <button class="mode-switch" id="cameraSwitch" title="Switch Camera">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            
            <div class="button-group">
                <button id="verifyBtn" class="button" disabled>
                    <i class="fas fa-camera"></i>
                    Verifikasi Wajah
                </button>
                <button id="altVerifyBtn" class="button button-alt">
                    <i class="fas fa-signature"></i>
                    Verifikasi Tanda Tangan
                </button>
            </div>
            
            <div id="statusMessage" class="status-message" style="display: none;"></div>
        </div>
        
        <!-- Signature Verification Container -->
        <div class="card signature-container" id="signatureContainer">
            <div class="signature-challenge" id="signatureChallenge">
                Silakan buat tanda tangan Anda:
            </div>
            <canvas id="signatureCanvas"></canvas>
            <div class="signature-controls">
                <button id="clearSignatureBtn" class="button button-alt">
                    <i class="fas fa-eraser"></i>
                    Hapus
                </button>
                <button id="submitSignatureBtn" class="button">
                    <i class="fas fa-paper-plane"></i>
                    Kirim Tanda Tangan
                </button>
            </div>
        </div>
        
        <div id="debug-console"></div>
        
        <div class="footer">
            <p>@Realsonnet</p>
            <p style="margin-top: 5px;">Verifikasi dilakukan tanpa penyimpanan data.</p>
        </div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <span id="loadingText">Memverifikasi...</span>
    </div>

    <script>
        // Debug Console Functions
        function debugLog(message, type = 'info') {
            const debugConsole = document.getElementById('debug-console');
            const timestamp = new Date().toLocaleTimeString();
            let color = '#fff';
            
            switch(type) {
                case 'error':
                    color = '#ff5252';
                    break;
                case 'success':
                    color = '#4caf50';
                    break;
                case 'warning':
                    color = '#ffc107';
                    break;
                default:
                    color = '#fff';
            }

            if (typeof message === 'object') {
                try {
                    message = JSON.stringify(message);
                } catch (e) {
                    message = "[Object can't be stringified]";
                }
            }
            
            debugConsole.innerHTML += `<div style="color:${color};">[${timestamp}] ${message}</div>`;
            debugConsole.scrollTop = debugConsole.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // URL Parameters and Storage
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const chatId = urlParams.get('chatId');
        const userIdFromUrl = urlParams.get('userId');

        debugLog(`Raw URL parameters: ${window.location.search}`);
        debugLog(`Extracted from URL: token=${token}, chatId=${chatId}, userId=${userIdFromUrl}`);
        
        if (userIdFromUrl) {
            localStorage.setItem('userId', userIdFromUrl);
            debugLog(`Stored userId in localStorage: ${userIdFromUrl}`, 'success');
        }
        
        if (chatId) {
            localStorage.setItem('chatId', chatId);
            debugLog(`Stored chatId in localStorage: ${chatId}`, 'success');
        }
        
        if (token) {
            localStorage.setItem('token', token);
            debugLog(`Stored token in localStorage: ${token}`, 'success');
        }
        
        // Telegram WebApp initialization
        let tg = null;
        let userId = null;
        let initData = '';
        
        if (window.Telegram && window.Telegram.WebApp) {
            try {
                tg = window.Telegram.WebApp;
                debugLog(`Telegram WebApp available: true`);
                debugLog(`WebApp version: ${tg.version}`);
                debugLog(`Platform: ${tg.platform}`);
                
                initData = tg.initData || '';
                debugLog(`Init data length: ${initData.length} characters`);
                
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    userId = tg.initDataUnsafe.user.id;
                    debugLog(`User ID from Telegram: ${userId}`, 'success');
                    debugLog(`User Info: ${JSON.stringify({
                        first_name: tg.initDataUnsafe.user.first_name,
                        username: tg.initDataUnsafe.user.username || 'None'
                    })}`);
                    
                    localStorage.setItem('userId', userId);
                } else {
                    debugLog(`No user data in initDataUnsafe`, 'warning');
                }
                
                if (tg.initDataUnsafe) {
                    debugLog(`Start param: ${tg.initDataUnsafe.start_param || 'none'}`);
                    debugLog(`Chat instance: ${tg.initDataUnsafe.chat_instance || 'none'}`);
                    debugLog(`Chat type: ${tg.initDataUnsafe.chat_type || 'none'}`);
                    
                    if (tg.initDataUnsafe.chat && tg.initDataUnsafe.chat.id) {
                        debugLog(`Chat ID from initDataUnsafe: ${tg.initDataUnsafe.chat.id}`, 'success');
                        localStorage.setItem('chatId', tg.initDataUnsafe.chat.id);
                    }
                }
                
                tg.expand();
                tg.MainButton.setParams({
                    text: 'Verifikasi',
                    color: '#3390EC'
                });
            } catch (e) {
                debugLog(`Error initializing Telegram WebApp: ${e.message}`, 'error');
            }
        } else {
            debugLog(`Telegram WebApp available: false`, 'warning');
            debugLog(`WARNING: Telegram WebApp is not available!`, 'warning');
        }
        
        userId = userId || userIdFromUrl || localStorage.getItem('userId') || '';
        debugLog(`Final userId being used: ${userId || 'Not available'}`, userId ? 'success' : 'warning');
        
        // DOM Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const verifyBtn = document.getElementById('verifyBtn');
        const altVerifyBtn = document.getElementById('altVerifyBtn');
        const statusMessage = document.getElementById('statusMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const cameraSwitch = document.getElementById('cameraSwitch');
        const ctx = canvas.getContext('2d');
        
        // Signature elements
        const signatureContainer = document.getElementById('signatureContainer');
        const signatureCanvas = document.getElementById('signatureCanvas');
        const signatureChallenge = document.getElementById('signatureChallenge');
        const clearSignatureBtn = document.getElementById('clearSignatureBtn');
        const submitSignatureBtn = document.getElementById('submitSignatureBtn');
        const signatureCtx = signatureCanvas.getContext('2d');
        
        // Variables
        let stream = null;
        let verificationTimeout = null;
        let cameraStartTimeout = null;
        let isDrawing = false;
        let signatureToken = null;
        let challengeText = null;
        let facingMode = 'user'; // default front camera
        
        const TIMEOUT_DURATION = 120000; // 2 minutes
        const CAMERA_START_TIMEOUT = 15000; // 15 seconds
        
        // Helper Functions
        function showLoading(message = 'Memverifikasi...') {
            document.getElementById('loadingText').textContent = message;
            loadingOverlay.classList.add('show');
        }
        
        function hideLoading() {
            loadingOverlay.classList.remove('show');
        }
        
        function showStatus(message, type = 'normal') {
            statusMessage.innerHTML = '';
            
            // Add icon based on type
            let icon = '';
            if (type === 'error') {
                icon = '<i class="fas fa-exclamation-circle"></i>';
                statusMessage.className = 'status-message error';
            } else if (type === 'success') {
                icon = '<i class="fas fa-check-circle"></i>';
                statusMessage.className = 'status-message success';
            } else if (type === 'warning') {
                icon = '<i class="fas fa-exclamation-triangle"></i>';
                statusMessage.className = 'status-message warning';
            } else {
                statusMessage.className = 'status-message';
            }
            
            statusMessage.innerHTML = icon + message;
            statusMessage.style.display = 'flex';
        }
        
        // Setup signature canvas
        function setupSignatureCanvas() {
            // Set canvas size
            signatureCanvas.width = signatureCanvas.offsetWidth;
            signatureCanvas.height = signatureCanvas.offsetHeight;
            
            // Initialize signature canvas
            signatureCtx.lineWidth = 3;
            signatureCtx.lineJoin = 'round';
            signatureCtx.lineCap = 'round';
            signatureCtx.strokeStyle = '#000';
            
            // Mouse events
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            signatureCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                signatureCanvas.dispatchEvent(mouseEvent);
            });
            
            signatureCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                signatureCanvas.dispatchEvent(mouseEvent);
            });
            
            signatureCanvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup');
                signatureCanvas.dispatchEvent(mouseEvent);
            });
        }
        
        function startDrawing(e) {
            isDrawing = true;
            const { offsetX, offsetY } = getCoordinates(e);
            signatureCtx.beginPath();
            signatureCtx.moveTo(offsetX, offsetY);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            const { offsetX, offsetY } = getCoordinates(e);
            signatureCtx.lineTo(offsetX, offsetY);
            signatureCtx.stroke();
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        function getCoordinates(e) {
            let offsetX, offsetY;
            const rect = signatureCanvas.getBoundingClientRect();
            
            // Handle both mouse and touch events
            if (e.type.includes('touch')) {
                offsetX = e.touches[0].clientX - rect.left;
                offsetY = e.touches[0].clientY - rect.top;
            } else {
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
            }
            
            return { offsetX, offsetY };
        }
        
        function clearSignature() {
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        }
        
        function isCanvasEmpty() {
            const pixelData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height).data;
            
            // Check if all pixel data is empty (transparent)
            for (let i = 0; i < pixelData.length; i += 4) {
                if (pixelData[i + 3] !== 0) {
                    return false; // Found a non-transparent pixel
                }
            }
            
            return true; // All pixels are transparent
        }
        
        function startVerificationTimeout() {
            verificationTimeout = setTimeout(() => {
                debugLog('Verification timeout reached', 'warning');
                showStatus('Waktu verifikasi habis. Silakan coba lagi.', 'error');
                if (tg) {
                    tg.close();
                }
            }, TIMEOUT_DURATION);
        }
        
        // Camera Functions
        async function startCamera() {
            try {
                debugLog('🔍 URL Parameters Check:');
                debugLog(`userId from URL: ${userIdFromUrl || 'Not found'}`);
                debugLog(`chatId from URL: ${chatId || 'Not found'}`);
                debugLog(`token from URL: ${token || 'Not found'}`);
                
                debugLog('Requesting camera access...');
                
                let constraints = {
                    video: { 
                        facingMode: facingMode
                    },
                    audio: false
                };
                
                // If there's an existing stream, stop it
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Try to get any video first
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                debugLog('Camera access granted!', 'success');
                video.srcObject = stream;
                
                // Set a timeout for camera initialization
                cameraStartTimeout = setTimeout(() => {
                    if (!video.videoWidth || !video.videoHeight) {
                        debugLog('Camera stream not showing, attempting to recover...', 'warning');
                        
                        // Try with more specific constraints
                        restartCameraWithSpecificConstraints();
                    }
                }, CAMERA_START_TIMEOUT);
                
                video.onloadedmetadata = () => {
                    debugLog(`Video metadata loaded`);
                };
                
                video.onplaying = () => {
                    clearTimeout(cameraStartTimeout);
                    debugLog(`Video is playing, dimensions: ${video.videoWidth} x ${video.videoHeight}`);
                    if (video.videoWidth && video.videoHeight) {
                        verifyBtn.disabled = false;
                        showStatus('Kamera siap. Silakan klik tombol Verifikasi Wajah.', 'normal');
                    }
                };
                
                startVerificationTimeout();
            } catch (err) {
                debugLog(`Error accessing camera: ${err.name} - ${err.message}`, 'error');
                showStatus(`Tidak dapat mengakses kamera: ${err.message}. Silakan gunakan verifikasi tanda tangan.`, 'error');
                
                // If permission denied or device not found, offer alternative verification
                if (err.name === 'NotAllowedError' || err.name === 'NotFoundError') {
                    verifyBtn.disabled = true;
                }
            }
        }
        
        async function switchCamera() {
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            debugLog(`Switching camera to: ${facingMode}`);
            
            try {
                // Stop current stream
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Start new stream with different facing mode
                const constraints = {
                    video: { facingMode: facingMode },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                debugLog(`Camera switched to: ${facingMode}`, 'success');
            } catch (err) {
                debugLog(`Error switching camera: ${err.message}`, 'error');
                showStatus('Gagal mengganti kamera.', 'error');
                
                // Revert back
                facingMode = facingMode === 'user' ? 'environment' : 'user';
                startCamera();
            }
        }
        
        async function restartCameraWithSpecificConstraints() {
            try {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Try with more specific constraints
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                debugLog('Camera restarted with specific constraints', 'success');
            } catch (err) {
                debugLog(`Failed to restart camera: ${err.message}`, 'error');
                showStatus('Tidak dapat mengakses kamera dengan benar. Silakan gunakan verifikasi tanda tangan.', 'error');
            }
        }
        
        // Face Verification Function
        async function verifyFace() {
            try {
                if (!stream) {
                    showStatus('Kamera tidak tersedia.', 'error');
                    return;
                }
                
                showLoading('Memproses...');
                
                // Set canvas size to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Draw video frame to canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Get image data from canvas
                const imageData = canvas.toDataURL('image/jpeg', 0.9);
                
                debugLog('Image captured, sending for verification...');
                
                // Send image data to server
                const verificationData = {
                    image: imageData,
                    userId: userId,
                    chatId: chatId || localStorage.getItem('chatId'),
                    token: token || localStorage.getItem('token'),
                    initData: initData
                };
                
                // Perform verification API call
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(verificationData)
                });
                
                const result = await response.json();
                debugLog(`Verification result: ${JSON.stringify(result)}`);
                
                if (result.success) {
                    showStatus(result.message || 'Verifikasi berhasil!', 'success');
                    
                    // Close Telegram WebApp after delay
                    setTimeout(() => {
                        if (tg) {
                            tg.close();
                        }
                    }, 3000);
                } else {
                    showStatus(result.message || 'Verifikasi gagal, silakan coba lagi.', 'error');
                }
            } catch (error) {
                debugLog(`Error during verification: ${error.message}`, 'error');
                showStatus('Terjadi kesalahan saat verifikasi. Silakan coba lagi.', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Signature verification functions
        async function requestSignatureVerification() {
            try {
                showLoading('Mempersiapkan verifikasi tanda tangan...');
                
                const verificationData = {
                    userId: userId,
                    chatId: chatId || localStorage.getItem('chatId'),
                    token: token || localStorage.getItem('token'),
                    initData: initData
                };
                
                // Request signature challenge from server
                const response = await fetch('/api/alt-verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(verificationData)
                });
                
                const result = await response.json();
                debugLog(`Signature challenge result: ${JSON.stringify(result)}`);
                
                if (result.success) {
                    // Store signature token and challenge
                    signatureToken = result.signatureToken;
                    challengeText = result.challenge;
                    
                    // Show signature challenge 
                    signatureChallenge.textContent = `Silakan buat tanda tangan Anda:`;
                    
                    // Hide camera container and show signature container
                    document.getElementById('cameraContainer').style.display = 'none';
                    signatureContainer.style.display = 'flex';
                    document.querySelectorAll('.button-group')[0].style.display = 'none';
                    
                    // Setup signature canvas
                    setupSignatureCanvas();
                } else {
                    showStatus(result.message || 'Gagal mempersiapkan verifikasi tanda tangan.', 'error');
                }
            } catch (error) {
                debugLog(`Error requesting signature verification: ${error.message}`, 'error');
                showStatus('Terjadi kesalahan saat mempersiapkan verifikasi tanda tangan.', 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function submitSignature() {
            try {
                if (isCanvasEmpty()) {
                    showStatus('Silakan buat tanda tangan terlebih dahulu.', 'warning');
                    return;
                }
                
                showLoading('Mengirim tanda tangan...');
                
                // Get image data from signature canvas
                const signatureData = signatureCanvas.toDataURL('image/png');
                
                const verificationData = {
                    userId: userId,
                    chatId: chatId || localStorage.getItem('chatId'),
                    signatureData: signatureData,
                    signatureToken: signatureToken,
                    initData: initData
                };
                
                // Submit signature for verification
                const response = await fetch('/api/verify-signature', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(verificationData)
                });
                
                const result = await response.json();
                debugLog(`Signature verification result: ${JSON.stringify(result)}`);
                
                if (result.success) {
                    showStatus(result.message || 'Verifikasi tanda tangan berhasil!', 'success');
                    
                    // Close Telegram WebApp after delay
                    setTimeout(() => {
                        if (tg) {
                            tg.close();
                        }
                    }, 3000);
                } else {
                    showStatus(result.message || 'Verifikasi tanda tangan gagal.', 'error');
                }
            } catch (error) {
                debugLog(`Error submitting signature: ${error.message}`, 'error');
                showStatus('Terjadi kesalahan saat mengirim tanda tangan.', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Event Listeners
        verifyBtn.addEventListener('click', verifyFace);
        cameraSwitch.addEventListener('click', switchCamera);
        altVerifyBtn.addEventListener('click', requestSignatureVerification);
        clearSignatureBtn.addEventListener('click', clearSignature);
        submitSignatureBtn.addEventListener('click', submitSignature);
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('DOMContentLoaded, starting initialization');
            
            startCamera();
            
            debugLog('Camera initialization has been requested');
            
            // Check if debug should be shown
            if (urlParams.get('debug') === 'true') {
                document.getElementById('debug-console').style.display = 'block';
                debugLog('Debug mode enabled', 'success');
            }
        });
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // Restart camera when page becomes visible again
                debugLog('Page became visible, restarting camera');
                if (!stream || stream.getTracks()[0].readyState === 'ended') {
                    startCamera();
                }
            }
        });
        
        // Check for camera permission status
        if (navigator.permissions && navigator.permissions.query) {
            navigator.permissions.query({ name: 'camera' })
            .then((permissionStatus) => {
                debugLog(`Camera permission status: ${permissionStatus.state}`);
                
                if (permissionStatus.state === 'denied') {
                    showStatus('Akses kamera ditolak. Silakan aktifkan kamera atau gunakan verifikasi tanda tangan.', 'error');
                    verifyBtn.disabled = true;
                }
                
                permissionStatus.onchange = function() {
                    debugLog(`Camera permission status changed to: ${this.state}`);
                    if (this.state === 'granted') {
                        startCamera();
                    } else if (this.state === 'denied') {
                        showStatus('Akses kamera ditolak. Silakan aktifkan kamera atau gunakan verifikasi tanda tangan.', 'error');
                        verifyBtn.disabled = true;
                    }
                };
            });
        }
    </script>
</body>
</html>
